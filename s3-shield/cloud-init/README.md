# Deploy via cloud-init


This `cloud-init` framework can be used when starting up Varnish Enterprise from a cloud marketplace.

The following marketplace offers have been tested:
- AWS: https://aws.amazon.com/marketplace/pp/prodview-zv4ce5bhesz4i
- Azure: https://azuremarketplace.microsoft.com/en-us/marketplace/apps/varnish.varnish-enterprise?tab=PlansAndPrice
- Oracle Cloud: https://cloudmarketplace.oracle.com/marketplace/en_US/listing/99472700

There is also support for other platforms that offer `cloud-init`, but those will require a Varnish Enterprise license.

## Requirements

You'll need a cloud environment providing:

- `cloud-init` support
- instances with Varnish Enterprise already installed (e.g. official AWS, Azure & Oracle Cloud marketplace images)
- a Varnish Enterprise license key for other platforms that support `cloud-init`

## Get started

### Generating the cloud-init file

First, update `s3.conf` as explained in the top [README](../README.md).

Generate the `cloud-init` file by running

``` shell
./generate_yaml.sh
```

This will create `cloud-init-s3-shield.yaml` that can then be use for deployment on Cloud platforms that come with Varnish Enterprise preinstalled.

If you're planning to run the S3 Shield on a platform that supports `cloud-init`, but that doesn't have Varnish Enterprise preinstalled, you need a Varnish Enterprise license key.

In that case, you need to run the following `generate_yaml.sh` command and add the Varnish Enterprise license key as an argument:

``` shell
./generate_yaml.sh <license-key>
```

By adding the license key, the generated `cloud-init` script will contain the necessary commands to install Varnish Enterprise using the provided key.

## Using the cloud-init file

### Start up server from web console/web UI

The content of `cloud-init-s3-shield.yaml` is usually pasted as-is in a text field, for example, when you start an instance:
- in AWS the text field is called "user-data"
- in Azure it's call "Custom data"

### Start up server with aws cli

You can use the following command to start up a server with the aws cli while using the cloud-init file
```
aws ec2 run-instances --user-data file://cloud-init-s3-shield.yaml --image-id ami-04f7fdfcf240e9aea --count 1 --instance-type t2.micro --key-name thapnes-varnish --security-group-ids sg-059dd7e6c4b33f308 --subnet-id subnet-007d144ca8f15b09c
```
- `cloud-init-s3-shield.yaml` is the file generated by `cloud-init/generate_yaml.sh`
- `subnet-id`, `security-group-id` and `key-name` are mandatory and depend on your setup
- image-id is the id of the marketplace image you will start. See under for finding correct id

#### Find image-id for the AMI
We have 4 different offer in AWS. Use the following commands to search for it (region have to be the same as the region you want to start it in)

1. Varnish Enterprise 6 (Ubuntu)
```
aws ec2 describe-images --owner 679593333241 --filters "Name=name,Values=circleci_VE_6_ubuntu_20.04*" --region us-east-1 --profile thapnes| jq '.Images[] | {CreationDate, ImageId, Name, ProductCodes} | select(.ProductCodes[].ProductCodeId == "1sm4r3rzd5ttylhc0y6ncjzid")'
```
2. Varnish Enterprise 6 (Red Hat)
```
aws ec2 describe-images --owner 679593333241 --filters "Name=name,Values=circleci_VE_6_redhat-8*" --region us-east-1 --profile thapnes| jq '.Images[] | {CreationDate, ImageId, Name, ProductCodes} | select(.ProductCodes[].ProductCodeId == "9ffjq19k4o9wt7xqomsq9sgsh")'
```
3. Varnish Enterprise 6 Developer Edition (Ubuntu)
```
aws ec2 describe-images --owner 679593333241 --filters "Name=name,Values=circleci_VE_6_ubuntu_20.04*" --region us-east-1 --profile thapnes| jq '.Images[] | {CreationDate, ImageId, Name, ProductCodes} | select(.ProductCodes[].ProductCodeId == "19b0kf2j6zpms82z0i9ic5fjh")'
```
4. Varnish Enterprise 6 Developer Edition (Red Hat)
```
aws ec2 describe-images --owner 679593333241 --filters "Name=name,Values=circleci_VE_6_redhat-8*" --region us-east-1 --profile thapnes| jq '.Images[] | {CreationDate, ImageId, Name, ProductCodes} | select(.ProductCodes[].ProductCodeId == "80eygom6khjw10kdlf5z7iu82")'
```

All command over will probably list out 3 images each (we tend to keep the latest three update public), you should pick the lastest one (according to `CreationDate`)
